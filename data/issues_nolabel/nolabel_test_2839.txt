Restore a working CMake build

This includes changes from #2705, which fixed some of the breakage.