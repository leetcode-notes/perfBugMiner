memmap changes

@andrewharp  @martinwicke
Here is the new PR with changes as discussed in 12922