remove duplicated code

remove duplicated code, and merge two implements.